{"version":3,"sources":["../src/angularjs-captcha.js"],"names":["angular","config","$httpProvider","interceptors","push","captchaSettings","configuredSettings","captchaEndpoint","setSettings","settings","$get","extend","captchaEndpointFilter","url","replace","captchaHelper","$window","trim","string","buildUrl","params","p","key","test","join","scriptInclude","className","script","document","createElement","src","captchaHttpInterceptor","request","beforeSend","botdetectCaptchaDirective","$document","$rootScope","$http","$filter","restrict","link","scope","element","attrs","styleName","stylename","captchaStyleName","bodyElement","find","method","get","c","getElementsByClassName","length","scriptIncludeUrl","append","initScriptIncluded","parentNode","removeChild","then","response","captchaHtmlWithoutScripts","data","html","initScriptIncludeUrl","t","querySelector","value","cs","error","Error","correctCaptchaDirective","Captcha","require","ctrls","captcha","captchaCode","ngModel","$setValidity","bind","val","validate","isHuman","reloadImage","captchaService","BotDetect","this","captchaId","getBotDetectInstance","getInstanceByStyleName","prototype","validationUrl","i","module","provider","filter","factory","directive","window"],"mappings":"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","file":"angularjs-captcha.min.js","sourcesContent":["/* BotDetect AngularJS CAPTCHA Module */\r\n\r\n(function(angular) {\r\n  'use strict';\r\n\r\n  function config($httpProvider) {\r\n    $httpProvider.interceptors.push('captchaHttpInterceptor'); \r\n  }\r\n\r\n  /**\r\n   * BotDetect Captcha module settings.\r\n   */\r\n  function captchaSettings() {\r\n    var configuredSettings = {},\r\n        captchaSettings = {\r\n          captchaEndpoint: ''\r\n        };\r\n\r\n    return {\r\n      setSettings: function(settings) {\r\n        configuredSettings = settings;\r\n      },\r\n\r\n      $get: function() {\r\n        angular.extend(captchaSettings, configuredSettings);\r\n        return captchaSettings;\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Strip '/' character from the end of the given url.\r\n   */\r\n  function captchaEndpointFilter() {\r\n    return function(url) {\r\n      return url.replace(/\\/+$/g, '');\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Captcha helper that provides useful functions.\r\n   */\r\n  function captchaHelper($window) {\r\n    return {\r\n      // strip whitespace from the beginning and end of the given string\r\n      trim: function(string) {\r\n        return string.replace(/^\\s+|\\s+$/g, '');\r\n      },\r\n\r\n      // build url with parameters\r\n      buildUrl: function(url, params) {\r\n        var p = [];\r\n\r\n        for (var key in params) {\r\n          if (typeof key === 'string') {\r\n            p.push(key + '=' + params[key]);\r\n          }\r\n        }\r\n\r\n        var hasParamsPattern = /\\?+/g;\r\n        return hasParamsPattern.test(url) ? (url + '&' + p.join('&')) : (url + '?' + p.join('&'));\r\n      },\r\n\r\n      // create script include element\r\n      scriptInclude: function(url, className) {\r\n        var script = $window.document.createElement('script');\r\n            script.src = url;\r\n            script.className = className;\r\n        return script;\r\n      }\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Register beforeSend() function for Http request.\r\n   */\r\n  function captchaHttpInterceptor() {\r\n    return {\r\n      request: function(config) {\r\n        if (config.beforeSend) {\r\n          config.beforeSend();\r\n        }\r\n        return config;\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * <botdetect-captcha> directive element, which is used to display Captcha html markup.\r\n   */\r\n  function botdetectCaptchaDirective($document, $rootScope, $http, $filter, captchaSettings, captchaHelper) {\r\n    return {\r\n      restrict: 'E',\r\n      link: function(scope, element, attrs) {\r\n        var styleName = attrs.stylename ? attrs.stylename : 'defaultCaptcha';\r\n\r\n        // save styleName in $rootScope, that will be used in correctCaptcha directive and Captcha service for getting BotDetect instance\r\n        $rootScope.captchaStyleName = styleName;\r\n\r\n        // normalize captcha endpoint path\r\n        var captchaEndpoint = $filter('captchaEndpointFilter')(captchaHelper.trim(captchaSettings.captchaEndpoint));\r\n\r\n        // body element\r\n        var bodyElement = $document.find('body')[0];\r\n\r\n        $http({\r\n          method: 'GET',\r\n          url: captchaEndpoint,\r\n          params: {\r\n            get: 'html',\r\n            c: styleName\r\n          },\r\n          beforeSend: function() {\r\n            // append BotDetect client-side script to body once\r\n            if ($document[0].getElementsByClassName('BDC_ScriptInclude').length === 0) {\r\n              // build BotDetect client-side script include url\r\n              var scriptIncludeUrl = captchaHelper.buildUrl(captchaEndpoint, {\r\n                get: 'script-include'\r\n              });\r\n              angular.element(bodyElement).append(captchaHelper.scriptInclude(scriptIncludeUrl, 'BDC_ScriptInclude'));\r\n            }\r\n\r\n            // remove included BotDetect init script if it exists\r\n            var initScriptIncluded = $document[0].getElementsByClassName('BDC_InitScriptInclude');\r\n            if (initScriptIncluded.length !== 0) {\r\n              initScriptIncluded[0].parentNode.removeChild(initScriptIncluded[0]);\r\n            }\r\n          }\r\n        })\r\n          .then(function(response) {\r\n            // remove all botdetect script includes (script include and init script include)\r\n            // because angular won't execute them in default.\r\n            var captchaHtmlWithoutScripts = response.data.replace(/<script.*<\\/script>/g, '');\r\n\r\n            // show captcha html in view\r\n            element.html(captchaHtmlWithoutScripts);\r\n\r\n            // build BotDetect init script include url\r\n            var initScriptIncludeUrl = captchaHelper.buildUrl(captchaEndpoint, {\r\n              get: 'init-script-include',\r\n              c: styleName,\r\n              t: element[0].querySelector('#BDC_VCID_' + styleName).value,\r\n              cs: '200'\r\n            });\r\n\r\n            // append BotDetect init script to body\r\n            angular.element(bodyElement).append(captchaHelper.scriptInclude(initScriptIncludeUrl, 'BDC_InitScriptInclude'));\r\n          }, function(error) {\r\n            throw new Error(error.data);\r\n          });\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 'correct-captcha' directive attribute, which is used to perform ui captcha validaion.\r\n   */\r\n  function correctCaptchaDirective(Captcha) {\r\n    return {\r\n      restrict: 'A',\r\n      require: 'ngModel',\r\n      link: function(scope, element, attrs, ctrls) {\r\n        var captcha,\r\n            captchaCode,\r\n            ngModel = ctrls;\r\n\r\n        ngModel.$setValidity('incorrectCaptcha', false);\r\n\r\n        // client-side validate captcha on blur event\r\n        element.bind('blur', function() {\r\n          captchaCode = element.val();\r\n\r\n          if (!captchaCode) {\r\n            return;\r\n          }\r\n\r\n          if (!captcha) {\r\n            captcha = new Captcha();\r\n          }\r\n\r\n          captcha.validate(captchaCode)\r\n            .then(function(isHuman) {\r\n              if (isHuman) {\r\n                // correct captcha code\r\n                ngModel.$setValidity('incorrectCaptcha', true);\r\n              } else {\r\n                // incorrect captcha code\r\n                ngModel.$setValidity('incorrectCaptcha', false);\r\n                captcha.reloadImage();\r\n              }\r\n            });\r\n        });\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Captcha client-side instance exposes Captcha workflow functions and values.\r\n   */\r\n  function captchaService($rootScope, $http) {\r\n    var Captcha = function() {\r\n      if (typeof BotDetect === 'undefined') {\r\n        throw new Error('Can not create Captcha instance, please put \"new Captcha()\" inside function that will be invoked after form is submitted.');\r\n      }\r\n\r\n      this.captchaStyleName = $rootScope.captchaStyleName;\r\n      this.captchaId = Captcha.getBotDetectInstance().captchaId;\r\n    };\r\n\r\n    Captcha.getBotDetectInstance = function() {\r\n      if (!$rootScope.captchaStyleName) {\r\n        return null;\r\n      }\r\n      return BotDetect.getInstanceByStyleName($rootScope.captchaStyleName);\r\n    };\r\n\r\n    Captcha.prototype.validate = function(captchaCode) {\r\n      var promise = $http({\r\n          method: 'GET',\r\n          url: Captcha.getBotDetectInstance().validationUrl,\r\n          params: {\r\n            i: captchaCode\r\n          }\r\n        })\r\n          .then(function(response) {\r\n            return response.data;\r\n          }, function(error) {\r\n            return error.data;\r\n          });\r\n\r\n      return promise;\r\n    };\r\n\r\n    Captcha.prototype.reloadImage = function() {\r\n      Captcha.getBotDetectInstance().reloadImage();\r\n    };\r\n\r\n    return Captcha;\r\n  }\r\n\r\n  angular\r\n    .module('BotDetectCaptcha', [])\r\n    .config([\r\n      '$httpProvider',\r\n      config\r\n    ])\r\n    .provider('captchaSettings', captchaSettings)\r\n    .filter('captchaEndpointFilter', captchaEndpointFilter)\r\n    .factory('captchaHelper', [\r\n      '$window',\r\n      captchaHelper\r\n    ])\r\n    .factory('captchaHttpInterceptor', captchaHttpInterceptor)\r\n    .factory('Captcha', [\r\n      '$rootScope',\r\n      '$http',\r\n      captchaService\r\n    ])\r\n    .directive('botdetectCaptcha', [\r\n      '$document',\r\n      '$rootScope',\r\n      '$http',\r\n      '$filter',\r\n      'captchaSettings',\r\n      'captchaHelper',\r\n      botdetectCaptchaDirective\r\n    ])\r\n    .directive('correctCaptcha', [\r\n      'Captcha',\r\n      correctCaptchaDirective\r\n    ]);\r\n\r\n})(window.angular);\r\n"]}